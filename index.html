<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow State Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .date-display {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            flex-direction: row;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: #2c3e50;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            color: #fff;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .panel {
            display: none;
            background: #34495e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .panel.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .progress-ring {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke: #7f8c8d;
            stroke-width: 10;
        }

        .progress-ring-progress {
            fill: none;
            stroke: #2ecc71;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .habit-item, .todo-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #2c3e50;
            border-radius: 8px;
            transition: all 0.3s;
            border-left: 4px solid #3498db;
        }

        .habit-item.completed {
            opacity: 0.6;
            border-left-color: #2ecc71;
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
        }

        .habit-info { flex: 1; }
        .habit-name { font-weight: 600; }
        .habit-streak { font-size: 0.8em; color: #bdc3c7; }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit { background: #1abc9c; color: white; }
        .btn-delete { background: #e74c3c; color: white; margin-left: 5px; }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            font-weight: bold;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #2c3e50;
            color: white;
        }

        .timer-display {
            text-align: center;
            font-size: 4em;
            font-weight: bold;
            color: #3498db;
            margin: 30px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-controls, .timer-presets {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 12px;
            background: #2c3e50;
            border: 1px solid #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }
        .modal-content { background: #34495e; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; }

        #authSection input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Flow State Tracker</h1>
            <div class="date-display" id="dateDisplay"></div>
        </div>

        <div id="authSection" class="panel" style="display: block;">
            <h2>Sign In to Sync Data</h2>
            <br>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-primary" onclick="signIn()">Sign In</button>
                <button class="btn btn-edit" onclick="signUp()">Sign Up</button>
            </div>
            <p style="margin-top: 15px; font-size: 0.8em; opacity: 0.7;">Or use the app locally. Sign in to sync across devices.</p>
        </div>

        <div id="mainUI" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('today')">Today</button>
                <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="switchTab('habits')">Habits</button>
                <button class="tab" onclick="switchTab('timer')">Focus Timer</button>
                <button class="tab" onclick="switchTab('planning')">Planning</button>
                <button class="btn btn-delete" onclick="handleSignOut()" style="margin-left: auto;">Logout</button>
            </div>

            <div id="today" class="panel active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Today's Progress</div>
                        <div class="stat-value" id="todayProgress">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Current Streak</div>
                        <div class="stat-value" id="currentStreak">0 ðŸ”¥</div>
                    </div>
                </div>

                <div class="progress-ring">
                    <svg width="150" height="150">
                        <circle class="progress-ring-circle" cx="75" cy="75" r="65"></circle>
                        <circle class="progress-ring-progress" cx="75" cy="75" r="65" id="progressCircle" stroke-dasharray="408.4" stroke-dashoffset="408.4"></circle>
                    </svg>
                    <div class="progress-text" id="progressText">0%</div>
                </div>

                <h3>Daily Habits</h3>
                <div id="todayHabits" class="habit-list"></div>
                
                <h3 style="margin-top: 20px;">Tasks for Today</h3>
                <div id="todayTodos" class="todo-list"></div>
                <div id="motivationalQuote" class="motivational-quote" style="margin-top: 20px; text-align: center; font-style: italic; opacity: 0.7;"></div>
            </div>

            <div id="dashboard" class="panel">
                <h2>ðŸ“Š Dashboard</h2>
                <p>Analytics coming soon. Tracking habits is the first step!</p>
            </div>

            <div id="habits" class="panel">
                <h3>Manage Permanent Habits</h3>
                <div class="input-group">
                    <input type="text" id="habitInput" placeholder="New habit name...">
                    <button class="btn btn-primary" onclick="addHabit()">Add</button>
                </div>
                <div id="habitList"></div>
            </div>

            <div id="timer" class="panel">
                <div class="timer-presets">
                    <button class="preset-btn" onclick="setTimer(25)">Pomodoro (25m)</button>
                    <button class="preset-btn" onclick="setTimer(60)">Deep Work (60m)</button>
                    <button class="preset-btn" onclick="setTimer(5)">Break (5m)</button>
                </div>
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div class="timer-controls">
                    <button id="timerBtn" class="btn btn-primary" onclick="toggleTimer()">Start</button>
                    <button class="btn btn-delete" onclick="resetTimer()">Reset</button>
                </div>
            </div>

            <div id="planning" class="panel">
                <h3>Plan Tasks</h3>
                <div class="input-group">
                    <input type="text" id="todoInput" placeholder="Add a specific task...">
                    <button class="btn btn-primary" onclick="addTodo()">Add Task</button>
                </div>
                <div id="planningList"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. INITIALIZATION & AUTH
        const supabaseUrl = 'https://wbcjkwgwiozdgzbhdtak.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiY2prd2d3aW96ZGd6YmhkdGFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwOTM2ODAsImV4cCI6MjA4MjY2OTY4MH0.8KdYmmmIV_8qCML6rNRhvKMUbLh1YgOjFUySDLbaFDI';
        
        // Use a unique name to avoid CDN conflict
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let habits = JSON.parse(localStorage.getItem('flow_habits')) || [];
        let todos = JSON.parse(localStorage.getItem('flow_todos')) || [];
        let timerInterval = null;
        let timerSeconds = 1500;
        let isTimerRunning = false;

        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) alert(error.message); else alert('Check your email for confirmation!');
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
        }

        async function handleSignOut() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        // Listen for Auth State
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainUI').style.display = 'block';
                init();
            }
        });

        // 2. CORE LOGIC
        function init() {
            updateDateDisplay();
            checkMidnightReset();
            renderAll();
            showMotivationalQuote();
        }

        function updateDateDisplay() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString(undefined, options);
        }

        function checkMidnightReset() {
            const lastDate = localStorage.getItem('flow_last_date');
            const today = new Date().toDateString();
            if (lastDate !== today) {
                // Uncheck all habits for the new day
                habits = habits.map(h => ({ ...h, completedToday: false }));
                // Clear old todos (or keep them if you prefer)
                localStorage.setItem('flow_last_date', today);
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('flow_habits', JSON.stringify(habits));
            localStorage.setItem('flow_todos', JSON.stringify(todos));
            renderAll();
        }

        // 3. HABIT & TODO MANAGEMENT
        function addHabit() {
            const input = document.getElementById('habitInput');
            if (!input.value) return;
            habits.push({
                id: Date.now(),
                name: input.value,
                streak: 0,
                completedToday: false
            });
            input.value = '';
            saveData();
        }

        function toggleHabit(id) {
            habits = habits.map(h => {
                if (h.id === id) {
                    const newState = !h.completedToday;
                    return { ...h, completedToday: newState, streak: newState ? h.streak + 1 : Math.max(0, h.streak - 1) };
                }
                return h;
            });
            saveData();
        }

        function deleteHabit(id) {
            habits = habits.filter(h => h.id !== id);
            saveData();
        }

        function addTodo() {
            const input = document.getElementById('todoInput');
            if (!input.value) return;
            todos.push({ id: Date.now(), text: input.value, completed: false });
            input.value = '';
            saveData();
        }

        function toggleTodo(id) {
            todos = todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t);
            saveData();
        }

        function deleteTodo(id) {
            todos = todos.filter(t => t.id !== id);
            saveData();
        }

        // 4. UI RENDERING
        function switchTab(tabId) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function renderAll() {
            renderToday();
            renderHabitList();
            renderPlanning();
            calculateProgress();
        }

        function renderToday() {
            const habitContainer = document.getElementById('todayHabits');
            const todoContainer = document.getElementById('todayTodos');
            
            habitContainer.innerHTML = habits.map(h => `
                <div class="habit-item ${h.completedToday ? 'completed' : ''}">
                    <input type="checkbox" class="habit-checkbox" ${h.completedToday ? 'checked' : ''} onchange="toggleHabit(${h.id})">
                    <div class="habit-info">
                        <div class="habit-name">${h.name}</div>
                        <div class="habit-streak">${h.streak} day streak ðŸ”¥</div>
                    </div>
                </div>
            `).join('');

            todoContainer.innerHTML = todos.map(t => `
                <div class="todo-item">
                    <input type="checkbox" class="habit-checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo(${t.id})">
                    <span style="${t.completed ? 'text-decoration: line-through; opacity: 0.5' : ''}">${t.text}</span>
                    <button class="btn-delete" onclick="deleteTodo(${t.id})" style="margin-left: auto">Ã—</button>
                </div>
            `).join('');
        }

        function renderHabitList() {
            document.getElementById('habitList').innerHTML = habits.map(h => `
                <div class="habit-item">
                    <div class="habit-info"><strong>${h.name}</strong></div>
                    <button class="btn btn-delete" onclick="deleteHabit(${h.id})">Delete</button>
                </div>
            `).join('');
        }

        function renderPlanning() {
            document.getElementById('planningList').innerHTML = todos.map(t => `
                <div class="todo-item">
                    <span>${t.text}</span>
                    <button class="btn-delete" onclick="deleteTodo(${t.id})" style="margin-left: auto">Remove</button>
                </div>
            `).join('');
        }

        function calculateProgress() {
            const totalItems = habits.length + todos.length;
            const completedItems = habits.filter(h => h.completedToday).length + todos.filter(t => t.completed).length;
            const percent = totalItems === 0 ? 0 : Math.round((completedItems / totalItems) * 100);
            
            document.getElementById('todayProgress').innerText = percent + '%';
            document.getElementById('progressText').innerText = percent + '%';
            
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 65;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;

            const maxStreak = habits.length > 0 ? Math.max(...habits.map(h => h.streak)) : 0;
            document.getElementById('currentStreak').innerText = maxStreak + ' ðŸ”¥';
        }

        // 5. TIMER LOGIC
        function setTimer(mins) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerSeconds = mins * 60;
            updateTimerDisplay();
            document.getElementById('timerBtn').innerText = 'Start';
        }

        function toggleTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                document.getElementById('timerBtn').innerText = 'Resume';
            } else {
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateTimerDisplay();
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        alert("Time's up! Great focus.");
                    }
                }, 1000);
                document.getElementById('timerBtn').innerText = 'Pause';
            }
            isTimerRunning = !isTimerRunning;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerSeconds = 1500;
            updateTimerDisplay();
            document.getElementById('timerBtn').innerText = 'Start';
        }

        function updateTimerDisplay() {
            const m = Math.floor(timerSeconds / 60);
            const s = timerSeconds % 60;
            document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function showMotivationalQuote() {
            const quotes = [
                "Discipline is choosing between what you want now and what you want most.",
                "Flow follows focus.",
                "Small wins compound into massive transformations.",
                "Your future self will thank you for today's effort."
            ];
            document.getElementById('motivationalQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
        }

        // Initial setup for guest mode or check session
        window.onload = () => {
            // Check if user already logged in
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('mainUI').style.display = 'block';
                    init();
                }
            });
        };
    </script>
</body>
</html>
